<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bakery Pro - Radio Fixed</title>
    <style>
        :root { --blue: #3498db; --green: #2ecc71; --orange: #e67e22; --bg: #f4f7f6; --dark: #2c3e50; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 8px; display: flex; flex-direction: column; align-items: center; }
        .radio-wrapper { width: 100%; max-width: 500px; margin-bottom: 8px; text-align: center; }
        .toggle-radio { background: var(--dark); color: white; border: none; padding: 10px 15px; border-radius: 20px; font-size: 11px; font-weight: bold; cursor: pointer; margin: 4px; transition: opacity 0.2s; }
        .toggle-radio:active { opacity: 0.7; }
        .container { width: 100%; max-width: 500px; background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid #ddd; }
        .tabs-header { display: flex; background: #fff; border-bottom: 2px solid #eee; padding: 6px; gap: 4px; overflow-x: auto; }
        .tab-btn { flex: 1; min-width: 85px; padding: 12px 2px; cursor: pointer; font-weight: 800; font-size: 10px; border-radius: 8px; color: #7f8c8d; background: #fff; border: 2px solid #ecf0f1; }
        .tab-btn.active { border-color: var(--blue); color: var(--blue); background: #f0f7ff; }
        .tab-content { display: none; padding: 12px; }
        .tab-content.active { display: block; }
        .main-inputs { background: #fff9e6; padding: 10px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #f9ebbe; }
        .row { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; background: white; border-radius: 8px; padding: 4px; border: 1px solid #eee; }
        .drag-handle { cursor: grab; color: #bdc3c7; font-size: 18px; padding: 0 5px; user-select: none; }
        .drag-handle::before { content: "‚†ø"; }
        .row.dragging { opacity: 0.3; background: #f0f0f0; }
        .name-in { flex: 2; font-weight: bold; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; outline: none; }
        .val-p { width: 55px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-weight: bold; outline: none; }
        .res-box { background: #f0f7ff; padding: 8px; border-radius: 6px; width: 80px; text-align: center; font-weight: 900; color: var(--blue); border: 1px solid #d0e4ff; }
        .sum-box { background: var(--green); color: white; padding: 15px; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold; margin-top: 15px; }
        .res-out { background: white; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-weight: 900; font-size: 24px; text-align: center; color: var(--blue); }
        
        .calc-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .calc-title { font-size: 13px; font-weight: 800; text-transform: uppercase; margin-bottom: 10px; text-align: center; color: var(--dark); }
        .calc-row { display: flex; align-items: center; justify-content: center; gap: 5px; flex-wrap: wrap; }
        .calc-input { width: 55px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-weight: bold; }
        .calc-res { width: 65px; padding: 8px; border: 1px solid var(--blue); border-radius: 6px; text-align: center; font-weight: 800; background: #f0f7ff; color: var(--blue); }
        .calc-btn { background: #4a86e8; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 11px; }
        
        .action-btns { display: flex; gap: 8px; margin-top: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; font-size: 12px; }
        .save-btn { background: var(--blue); }
        .reset-btn { background: #95a5a6; }
        label { font-size: 11px; font-weight: bold; color: #7f8c8d; margin-bottom: 4px; display: block; }
    </style>
</head>
<body>

<div class="radio-wrapper">
    <button class="toggle-radio" onclick="toggleStream('')">üõë STOP</button>
    <button class="toggle-radio" onclick="toggleStream('https://icecast.wallis.ch/zenfm-high')">üçÉ CHILL (Zen)</button>
    <button class="toggle-radio" onclick="toggleStream('https://rfcmedia.streamguys1.com/90sAlternative.mp3')">üé∏ 90s ALT</button>
    <audio id="mainAudio" preload="none"></audio>
</div>

<div class="container">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="openTab(event, 'bread')">ü•ñ –†–ï–¶–ï–ü–¢–ê</button>
        <button class="tab-btn" onclick="openTab(event, 'perc')">ÔºÖ –°–ú–ï–¢–ö–ò</button>
        <button class="tab-btn" onclick="openTab(event, 'levain-recipe')">üß™ –ö–í–ê–° (–†–ï–¶)</button>
        <button class="tab-btn" onclick="openTab(event, 'levain-ext')">‚öñÔ∏è –ö–í–ê–° (–û–ë–©)</button>
    </div>

    <div id="bread" class="tab-content active">
        <div class="main-inputs">
            <label>–ñ–ï–õ–ê–ù–û –û–ë–©–û –¢–ï–°–¢–û (–≥—Ä):</label>
            <input type="number" id="targetTotal" style="width:100%; border:none; background:transparent; font-size:22px; font-weight:900; outline:none;" value="1400" oninput="recalc('total')">
            <div style="border-top:1px solid #f9ebbe; margin:8px 0;"></div>
            <label>–ò–õ–ò –ù–ê–õ–ò–ß–ù–û –ë–†–ê–®–ù–û (–≥—Ä):</label>
            <input type="number" id="targetFlour" style="width:100%; border:none; background:transparent; font-size:22px; font-weight:900; outline:none; color:var(--orange);" oninput="recalc('flour')">
        </div>

        <div id="sortable-list"></div>

        <div class="sum-box">–û–ë–©–û –¢–ï–°–¢–û: <span id="totalSum">0</span> –≥—Ä.</div>
        
        <div class="action-btns">
            <button class="btn save-btn" onclick="saveRecipe()">üíæ –ó–ê–ü–ê–ó–ò</button>
            <button class="btn reset-btn" onclick="resetToTemplate()">üîÑ –ù–£–õ–ò–†–ê–ô</button>
        </div>
    </div>

    <div id="perc" class="tab-content">
        <div class="calc-section">
            <div class="calc-title">–ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –∑–∞ –ø—Ä–æ—Ü–µ–Ω—Ç</div>
            <div class="calc-row">
                <input type="number" id="p1_v1" class="calc-input" value="10">
                <span>–µ –∫–∞–∫—ä–≤ % –æ—Ç</span>
                <input type="number" id="p1_v2" class="calc-input" value="100">
                <span>? =</span>
                <input type="text" id="p1_res" class="calc-res" readonly>
                <span>%</span>
                <button class="calc-btn" onclick="calcP1()">–ò–∑—á–∏—Å–ª–∏!</button>
            </div>
        </div>
        <div class="calc-section">
            <div class="calc-title">–ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Å—Ç–æ–π–Ω–æ—Å—Ç</div>
            <div class="calc-row">
                <span>–ö–æ–ª–∫–æ —Å–∞</span>
                <input type="number" id="p2_v1" class="calc-input" value="10">
                <span>% –æ—Ç</span>
                <input type="number" id="p2_v2" class="calc-input" value="100">
                <span>? =</span>
                <input type="text" id="p2_res" class="calc-res" readonly>
                <button class="calc-btn" onclick="calcP2()">–ò–∑—á–∏—Å–ª–∏!</button>
            </div>
        </div>
        <div class="calc-section" style="border:none;">
            <div class="calc-title">–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ø—Ä–æ—Ü–µ–Ω—Ç –∫—ä–º —á–∏—Å–ª–æ</div>
            <div class="calc-row">
                <input type="number" id="p3_v1" class="calc-input" value="100">
                <span>+</span>
                <input type="number" id="p3_v2" class="calc-input" value="10">
                <span>% =</span>
                <input type="text" id="p3_res" class="calc-res" readonly>
                <button class="calc-btn" onclick="calcP3()">–ò–∑—á–∏—Å–ª–∏!</button>
            </div>
        </div>
    </div>

    <div id="levain-recipe" class="tab-content">
        <label>–ö–í–ê–° –í –†–ï–¶–ï–ü–¢–ê–¢–ê:</label>
        <div id="lev_needed" class="res-out" style="color:var(--orange);">0 –≥—Ä.</div>
        <label style="margin-top:15px;">–•–ò–î–†–ê–¢–ê–¶–ò–Ø –ù–ê –ö–í–ê–°–ê (%):</label>
        <input type="number" id="lev_h" class="val-p" value="100" style="width:100%" oninput="recalc('current')">
        <div style="display:flex; gap:10px; margin-top:15px;">
            <div style="flex:1;"><label>–ë–†–ê–®–ù–û</label><div id="l_f" class="res-out">0</div></div>
            <div style="flex:1;"><label>–í–û–î–ê</label><div id="l_w" class="res-out">0</div></div>
        </div>
    </div>

    <div id="levain-ext" class="tab-content">
        <label>–ñ–ï–õ–ê–ù–û –ö–û–õ–ò–ß–ï–°–¢–í–û –ö–í–ê–° (–≥—Ä):</label>
        <input type="number" id="ext_total" class="val-p" value="300" style="width:100%; margin-bottom:15px;" oninput="calcExtLevain()">
        <label>–•–ò–î–†–ê–¢–ê–¶–ò–Ø (%):</label>
        <input type="number" id="ext_hydr" class="val-p" value="100" style="width:100%;" oninput="calcExtLevain()">
        <div style="display:flex; gap:10px; margin-top:15px;">
            <div style="flex:1;"><label>–ë–†–ê–®–ù–û</label><div id="ext_f_res" class="res-out">150</div></div>
            <div style="flex:1;"><label>–í–û–î–ê</label><div id="ext_w_res" class="res-out">150</div></div>
        </div>
    </div>
</div>

<script>
    let lastMode = 'total';
    const audio = document.getElementById('mainAudio');
    const template = [
        {n:"–ë—è–ª–æ –ë—Ä–∞—à–Ω–æ", p:90, r:true},
        {n:"–ü—ä–ª–Ω–æ–∑—ä—Ä–Ω–µ—Å—Ç–æ", p:10, r:false},
        {n:"–í–æ–¥–∞", p:64, r:false},
        {n:"–°–æ–ª", p:2.25, r:false},
        {n:"–ó–µ—Ö—Ç–∏–Ω", p:1.25, r:false},
        {n:"–ö–≤–∞—Å", p:0, r:false},
        {n:"", p:0, r:false},
        {n:"", p:0, r:false},
        {n:"", p:0, r:false}
    ];

    function toggleStream(url) {
        if (!url) {
            audio.pause();
            audio.src = "";
            return;
        }
        if (audio.src === url && !audio.paused) {
            audio.pause();
        } else {
            audio.src = url;
            audio.load();
            audio.play().catch(e => alert("–ú–æ–ª—è, –Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ –æ—Ç–Ω–æ–≤–æ –∑–∞ —Å—Ç–∞—Ä—Ç –Ω–∞ –º—É–∑–∏–∫–∞—Ç–∞."));
        }
    }

    function openTab(e, name) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(name).style.display = 'block';
        e.currentTarget.classList.add('active');
    }

    function createRow(data) {
        const div = document.createElement('div');
        div.className = "row draggable";
        div.draggable = true;
        div.innerHTML = `
            <div class="drag-handle"></div>
            <input type="text" class="name-in" value="${data.n}">
            <input type="number" class="val-p ${data.r ? 'f1-p' : (data.n === '–ü—ä–ª–Ω–æ–∑—ä—Ä–Ω–µ—Å—Ç–æ' ? 'f2-p' : 'other-p')}" 
                   value="${data.p}" ${data.r ? 'readonly' : ''} 
                   oninput="${data.n === '–ü—ä–ª–Ω–æ–∑—ä—Ä–Ω–µ—Å—Ç–æ' ? 'adjustFlour()' : 'recalc(lastMode)'}">
            <div class="res-box">0</div>
        `;
        return div;
    }

    function adjustFlour() {
        const f2Input = document.querySelector('.f2-p');
        const f1Input = document.querySelector('.f1-p');
        if (f1Input && f2Input) {
            let f2 = parseFloat(f2Input.value) || 0;
            if(f2 > 100) f2 = 100;
            f1Input.value = (100 - f2).toFixed(2).replace(/\.?0+$/, '');
        }
        recalc(lastMode);
    }

    function recalc(mode) {
        if(mode !== 'current') lastMode = mode;
        const tT = parseFloat(document.getElementById('targetTotal').value) || 0;
        const tF = parseFloat(document.getElementById('targetFlour').value) || 0;
        let otherP = 0;
        document.querySelectorAll('.other-p').forEach(i => otherP += (parseFloat(i.value) || 0));
        let totalP = 100 + otherP;
        let unit = (lastMode === 'flour' && tF > 0) ? (tF / 100) : (tT / totalP);
        if(lastMode === 'total' && mode !== 'current') document.getElementById('targetFlour').value = Math.round(unit * 100);
        if(lastMode === 'flour' && mode !== 'current') document.getElementById('targetTotal').value = Math.round(unit * totalP);

        let levG = 0;
        document.querySelectorAll('.row').forEach(row => {
            const p = parseFloat(row.querySelector('.val-p').value) || 0;
            const res = Math.round(unit * p);
            row.querySelector('.res-box').innerText = res;
            if(row.querySelector('.name-in').value.toLowerCase().includes('–∫–≤–∞—Å')) levG = res;
        });

        document.getElementById('totalSum').innerText = Math.round(unit * totalP);
        const h = parseFloat(document.getElementById('lev_h').value) || 100;
        const lF = levG / (1 + (h/100));
        document.getElementById('lev_needed').innerText = Math.round(levG) + " –≥—Ä.";
        document.getElementById('l_f').innerText = Math.round(lF);
        document.getElementById('l_w').innerText = Math.round(levG - lF);
    }

    function calcP1() {
        const v1 = parseFloat(document.getElementById('p1_v1').value);
        const v2 = parseFloat(document.getElementById('p1_v2').value);
        document.getElementById('p1_res').value = v2 ? ((v1/v2)*100).toFixed(1) : 0;
    }
    function calcP2() {
        const v1 = parseFloat(document.getElementById('p2_v1').value);
        const v2 = parseFloat(document.getElementById('p2_v2').value);
        document.getElementById('p2_res').value = ((v1/100)*v2).toFixed(1);
    }
    function calcP3() {
        const v1 = parseFloat(document.getElementById('p3_v1').value);
        const v2 = parseFloat(document.getElementById('p3_v2').value);
        document.getElementById('p3_res').value = (v1 * (1 + v2/100)).toFixed(1);
    }
    function calcExtLevain() {
        const t = parseFloat(document.getElementById('ext_total').value) || 0;
        const h = parseFloat(document.getElementById('ext_hydr').value) || 100;
        const f = t / (1 + (h/100));
        document.getElementById('ext_f_res').innerText = Math.round(f);
        document.getElementById('ext_w_res').innerText = Math.round(t - f);
    }

    function saveRecipe() {
        const rows = [];
        document.querySelectorAll('.row').forEach(row => {
            rows.push({ n: row.querySelector('.name-in').value, p: row.querySelector('.val-p').value, r: row.querySelector('.val-p').readOnly });
        });
        localStorage.setItem('bakery_v3', JSON.stringify(rows));
        localStorage.setItem('bakery_total_v3', document.getElementById('targetTotal').value);
        alert("–ó–∞–ø–∞–∑–µ–Ω–æ!");
    }

    function loadRecipe() {
        const saved = localStorage.getItem('bakery_v3');
        const savedTotal = localStorage.getItem('bakery_total_v3');
        const list = document.getElementById('sortable-list');
        list.innerHTML = "";
        const data = saved ? JSON.parse(saved) : template;
        if(savedTotal) document.getElementById('targetTotal').value = savedTotal;
        data.forEach(item => list.appendChild(createRow(item)));
        recalc('total');
    }

    function resetToTemplate() {
        if(confirm("–ù—É–ª–∏—Ä–∞–Ω–µ?")) { localStorage.removeItem('bakery_v3'); loadRecipe(); }
    }

    const list = document.getElementById('sortable-list');
    list.addEventListener('dragstart', e => e.target.classList.add('dragging'));
    list.addEventListener('dragend', e => { e.target.classList.remove('dragging'); recalc(lastMode); });
    list.addEventListener('dragover', e => {
        e.preventDefault();
        const draggable = document.querySelector('.dragging');
        const afterElement = [...list.querySelectorAll('.draggable:not(.dragging)')].reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = e.clientY - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset, element: child };
            return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
        if (afterElement == null) list.appendChild(draggable); else list.insertBefore(draggable, afterElement);
    });

    window.onload = loadRecipe;
</script>
</body>
</html>
